<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø­Ø±Ø± Ø§Ù„Ø¯Ù‚ÙŠÙ‚ - Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #1e1e2f;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }

        .app {
            max-width: 1400px;
            width: 100%;
            background: #2d2d3a;
            border-radius: 30px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        /* Ø±Ø£Ø³ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
        .header {
            background: #252532;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #3d3d4e;
        }

        .header h1 {
            color: white;
            font-size: 24px;
            font-weight: 600;
        }

        .header span {
            font-size: 28px;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 20px 30px;
            background: #2a2a35;
            border-bottom: 1px solid #3d3d4e;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 40px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            background: #3d3d4e;
            color: white;
            border: 1px solid #4d4d62;
        }

        .btn:hover {
            background: #4d4d62;
            transform: translateY(-2px);
        }

        .btn-primary {
            background: #4361ee;
            border: none;
        }

        .btn-primary:hover {
            background: #3a56d4;
        }

        .btn-success {
            background: #06d6a0;
            border: none;
            color: #1e1e2f;
        }

        .btn-success:hover {
            background: #05bf8b;
        }

        .btn-danger {
            background: #ef476f;
            border: none;
        }

        .btn-danger:hover {
            background: #d63e62;
        }

        .btn-warning {
            background: #ff9f1c;
            border: none;
            color: #1e1e2f;
        }

        .btn-warning:hover {
            background: #f08c0f;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ† */
        .color-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            padding: 15px 30px;
            background: #252532;
            border-bottom: 1px solid #3d3d4e;
        }

        .color-display {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #2d2d3a;
            padding: 6px 15px 6px 6px;
            border-radius: 40px;
            border: 1px solid #4d4d62;
        }

        #selectedColorBox {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 3px solid #4d4d62;
        }

        .color-label {
            color: #aaa;
            font-size: 14px;
        }

        .eyedropper-btn {
            background: #4361ee;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .eyedropper-btn.active {
            background: #06d6a0;
            transform: scale(1.1);
        }

        .tolerance-control {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 250px;
        }

        .tolerance-control label {
            color: #aaa;
            font-size: 14px;
            white-space: nowrap;
        }

        #toleranceRange {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #3d3d4e;
            accent-color: #4361ee;
        }

        #toleranceValue {
            min-width: 35px;
            color: #4361ee;
            font-weight: 600;
            text-align: center;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ */
        .workspace {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: #1a1a26;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ */
        .canvas-container {
            flex: 3;
            background: #0f0f17;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.5);
            position: relative;
            aspect-ratio: 13/18; /* Ù†Ø³Ø¨Ø© 13:18 Ø³Ù… */
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
            background: repeating-conic-gradient(#2d2d3a 0% 25%, #3d3d4e 0% 50%) 50% / 30px 30px;
        }

        /* Ù…Ø¤Ø´Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© - Ù‡Ø°Ø§ Ø§Ù„Ù„ÙŠ ÙŠØ¸Ù‡Ø± Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙˆØ³ */
        .brush-cursor {
            position: fixed;
            width: 40px;
            height: 40px;
            border: 3px solid white;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
            display: none;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            mix-blend-mode: difference;
        }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        .sidebar {
            flex: 1;
            background: #252532;
            border-radius: 24px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙØ±Ø´Ø§Ø© */
        .tools-section {
            background: #2d2d3a;
            border-radius: 20px;
            padding: 18px;
        }

        .section-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .brush-tools {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tool-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 30px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
            background: #3d3d4e;
            color: #aaa;
            border: 1px solid #4d4d62;
        }

        .tool-btn.eraser.active {
            background: #ef476f;
            color: white;
            border-color: #ef476f;
        }

        .tool-btn.restore.active {
            background: #06d6a0;
            color: #1e1e2f;
            border-color: #06d6a0;
        }

        /* Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ (Ø¬Ø¯ÙŠØ¯!) */
        .cancel-tool-btn {
            width: 100%;
            padding: 14px;
            background: #4d4d62;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }

        .cancel-tool-btn:hover {
            background: #5d5d7a;
        }

        /* Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø­Ø¬Ù… */
        .size-control {
            margin-top: 15px;
        }

        .size-label {
            display: flex;
            justify-content: space-between;
            color: #aaa;
            margin-bottom: 8px;
        }

        #brushSizeRange {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #3d3d4e;
            accent-color: #4361ee;
        }

        /* Ø®Ù„ÙÙŠØ§Øª */
        .backgrounds-section {
            background: #2d2d3a;
            border-radius: 20px;
            padding: 18px;
        }

        /* Ø±ÙØ¹ Ø®Ù„ÙÙŠØ© Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² */
        .upload-bg {
            background: #3d3d4e;
            border-radius: 30px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
            cursor: pointer;
            border: 2px dashed #4d4d62;
            transition: all 0.2s;
        }

        .upload-bg:hover {
            background: #4d4d62;
            border-color: #06d6a0;
        }

        .upload-bg label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
            cursor: pointer;
        }

        #bgFileInput {
            display: none;
        }

        /* Ø®Ù„ÙÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© */
        .quick-bg {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .bg-item {
            aspect-ratio: 1;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            overflow: hidden;
        }

        .bg-item:hover {
            transform: scale(0.95);
            border-color: #06d6a0;
        }

        .bg-item.selected {
            border-color: #4361ee;
        }

        .bg-color {
            width: 100%;
            height: 100%;
        }

        .bg-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø¬Ù… */
        .size-info {
            background: #2d2d3a;
            border-radius: 20px;
            padding: 18px;
            color: white;
        }

        .size-detail {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            color: #aaa;
        }

        .size-detail span:last-child {
            color: #06d6a0;
            font-weight: 600;
        }

        /* ØªØ°ÙŠÙŠÙ„ */
        .footer {
            padding: 15px 30px;
            background: #252532;
            color: #6d6d8a;
            text-align: center;
            font-size: 13px;
            border-top: 1px solid #3d3d4e;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <div class="header">
            <span>ğŸ¯</span>
            <h1>Ø§Ù„Ù…Ø­Ø±Ø± Ø§Ù„Ø¯Ù‚ÙŠÙ‚ - Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©</h1>
        </div>

        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div class="toolbar">
            <button class="btn" id="uploadImageBtn">
                <span>ğŸ“¸</span> Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©
            </button>
            <button class="btn btn-primary" id="removeBgBtn">
                <span>âœ‚ï¸</span> Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©
            </button>
            <button class="btn btn-success" id="addBgBtn">
                <span>ğŸ–¼ï¸</span> Ø¥Ø¶Ø§ÙØ© Ø®Ù„ÙÙŠØ©
            </button>
            <button class="btn btn-danger" id="saveBtn">
                <span>ğŸ’¾</span> Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©
            </button>
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
        </div>

        <!-- Ø´Ø±ÙŠØ· Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ† -->
        <div class="color-bar">
            <div class="color-display">
                <div id="selectedColorBox" style="background: #00ff00;"></div>
                <span class="color-label">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</span>
            </div>

            <button class="eyedropper-btn" id="eyedropperBtn" title="Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ† Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©">
                ğŸ–Œï¸
            </button>

            <div class="tolerance-control">
                <label>Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©:</label>
                <input type="range" id="toleranceRange" min="5" max="60" value="30">
                <span id="toleranceValue">30</span>
            </div>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ -->
        <div class="workspace">
            <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ -->
            <div class="canvas-container" id="canvasContainer">
                <canvas id="mainCanvas"></canvas>
            </div>

            <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
            <div class="sidebar">
                <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙØ±Ø´Ø§Ø© -->
                <div class="tools-section">
                    <div class="section-title">
                        <span>ğŸ–Œï¸</span> Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ±
                    </div>

                    <!-- Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ (Ø¬Ø¯ÙŠØ¯!) -->
                    <button class="cancel-tool-btn" id="cancelToolBtn">
                        <span>âŒ</span> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                    </button>

                    <div class="brush-tools">
                        <button class="tool-btn eraser" id="eraserBtn">
                            <span>ğŸ§½</span> Ù…Ù…Ø­Ø§Ø©
                        </button>
                        <button class="tool-btn restore" id="restoreBtn">
                            <span>ğŸ”„</span> Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                        </button>
                    </div>

                    <div class="size-control">
                        <div class="size-label">
                            <span>Ø­Ø¬Ù… Ø§Ù„ÙØ±Ø´Ø§Ø©</span>
                            <span id="brushSizeDisplay">20px</span>
                        </div>
                        <input type="range" id="brushSizeRange" min="5" max="50" value="20">
                    </div>
                </div>

                <!-- Ø®Ù„ÙÙŠØ§Øª -->
                <div class="backgrounds-section">
                    <div class="section-title">
                        <span>ğŸŒˆ</span> Ø§Ù„Ø®Ù„ÙÙŠØ§Øª
                    </div>

                    <!-- Ø±ÙØ¹ Ø®Ù„ÙÙŠØ© Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² -->
                    <div class="upload-bg" id="uploadBgArea">
                        <label for="bgFileInput">
                            <span>ğŸ“</span> Ø§Ø®ØªØ± Ø®Ù„ÙÙŠØ© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ
                        </label>
                        <input type="file" id="bgFileInput" accept="image/*">
                    </div>

                    <!-- Ø®Ù„ÙÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
                    <div class="quick-bg">
                        <div class="bg-item" data-type="color" data-color="#ff0000">
                            <div class="bg-color" style="background: #ff0000;"></div>
                        </div>
                        <div class="bg-item" data-type="color" data-color="#00ff00">
                            <div class="bg-color" style="background: #00ff00;"></div>
                        </div>
                        <div class="bg-item" data-type="color" data-color="#0000ff">
                            <div class="bg-color" style="background: #0000ff;"></div>
                        </div>
                        <div class="bg-item" data-type="color" data-color="#ffff00">
                            <div class="bg-color" style="background: #ffff00;"></div>
                        </div>
                        <div class="bg-item" data-type="color" data-color="#ff00ff">
                            <div class="bg-color" style="background: #ff00ff;"></div>
                        </div>
                        <div class="bg-item" data-type="color" data-color="#00ffff">
                            <div class="bg-color" style="background: #00ffff;"></div>
                        </div>
                        <div class="bg-item" data-type="image" data-url="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=200">
                            <img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=200" alt="Ø·Ø¨ÙŠØ¹Ø©" crossorigin="anonymous" loading="lazy">
                        </div>
                        <div class="bg-item" data-type="image" data-url="https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=200">
                            <img src="https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=200" alt="ØºØ§Ø¨Ø©" crossorigin="anonymous" loading="lazy">
                        </div>
                        <div class="bg-item" data-type="image" data-url="https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=200">
                            <img src="https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=200" alt="ØºØ±ÙˆØ¨" crossorigin="anonymous" loading="lazy">
                        </div>
                    </div>
                </div>

                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø¬Ù… -->
                <div class="size-info">
                    <div class="section-title">
                        <span>ğŸ“</span> Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø©
                    </div>
                    <div class="size-detail">
                        <span>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</span>
                        <span>Ù¡Ù£ Ã— Ù¡Ù¨ Ø³Ù…</span>
                    </div>
                    <div class="size-detail">
                        <span>Ø¯Ù‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</span>
                        <span>Ù£Ù Ù  Ø¨ÙƒØ³Ù„/Ø¨ÙˆØµØ©</span>
                    </div>
                    <div style="background: #3d3d4e; height: 1px; margin: 10px 0;"></div>
                    <div style="color: #aaa; font-size: 13px;">
                        <p>ğŸ–±ï¸ <strong>Ø§Ù„ÙØ±Ø´Ø§Ø©:</strong> Ø§Ø¶ØºØ· ÙˆØ§Ø³Ø­Ø¨ Ù„Ù„Ø­Ø°Ù/Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</p>
                        <p>ğŸ¯ <strong>Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©:</strong> ØªØ¸Ù‡Ø± Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙˆØ³</p>
                        <p>âŒ¨ï¸ <strong>Shift + Ø³Ø­Ø¨:</strong> Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ù„ÙÙŠØ©</p>
                        <p>ğŸ” <strong>Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø§ÙˆØ³:</strong> Ù„Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ±</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ØªØ°ÙŠÙŠÙ„ -->
        <div class="footer">
            Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø·Ø§Ø±Ø© ğŸ–Œï¸ Ø«Ù… Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø²Ø§Ù„ØªÙ‡ | Ø§Ù„ÙØ±Ø´Ø§Ø© ØªØ¹Ù…Ù„ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· ÙˆØ§Ù„Ø³Ø­Ø¨
        </div>
    </div>

    <!-- Ù…Ø¤Ø´Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© (Ø§Ù„Ù„ÙŠ ÙŠØ¸Ù‡Ø± Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙˆØ³) -->
    <div class="brush-cursor" id="brushCursor"></div>

    <script>
        // === ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ ===
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const container = document.getElementById('canvasContainer');
        
        // Ø¶Ø¨Ø· Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø¨Ù†Ø³Ø¨Ø© 13:18
        const containerRect = container.getBoundingClientRect();
        let canvasWidth = 800;
        let canvasHeight = 1108; // Ù†Ø³Ø¨Ø© 13:18
        
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;

        // === Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ===
        let originalImage = null;
        let processedImage = null;
        let backgroundImage = null;
        
        // Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù
        let targetColor = { r: 0, g: 255, b: 0 };
        let tolerance = 30;
        
        // Ø§Ù„Ù‚Ø·Ø§Ø±Ø©
        let isEyedropperActive = false;
        
        // Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙØ±Ø´Ø§Ø©
        let currentTool = null; // 'eraser', 'restore', Ø£Ùˆ null
        let isDrawing = false;
        let brushSize = 20;
        
        // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹Ù†Ø§ØµØ±
        let imageX = 0, imageY = 0, imageScale = 1;
        let bgX = 0, bgY = 0, bgScale = 1;
        let isDraggingImage = false;
        let isDraggingBg = false;
        let dragStart = { x: 0, y: 0 };

        // Ù…Ø¤Ø´Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
        const brushCursor = document.getElementById('brushCursor');

        // === Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… ===
        const uploadImageBtn = document.getElementById('uploadImageBtn');
        const imageInput = document.getElementById('imageInput');
        const removeBgBtn = document.getElementById('removeBgBtn');
        const addBgBtn = document.getElementById('addBgBtn');
        const saveBtn = document.getElementById('saveBtn');
        const eyedropperBtn = document.getElementById('eyedropperBtn');
        const selectedColorBox = document.getElementById('selectedColorBox');
        const toleranceRange = document.getElementById('toleranceRange');
        const toleranceValue = document.getElementById('toleranceValue');
        const eraserBtn = document.getElementById('eraserBtn');
        const restoreBtn = document.getElementById('restoreBtn');
        const cancelToolBtn = document.getElementById('cancelToolBtn');
        const brushSizeRange = document.getElementById('brushSizeRange');
        const brushSizeDisplay = document.getElementById('brushSizeDisplay');
        const bgFileInput = document.getElementById('bgFileInput');
        const uploadBgArea = document.getElementById('uploadBgArea');
        const bgItems = document.querySelectorAll('.bg-item');

        // === ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… ===
        toleranceRange.addEventListener('input', () => {
            tolerance = parseInt(toleranceRange.value);
            toleranceValue.textContent = tolerance;
        });

        brushSizeRange.addEventListener('input', () => {
            brushSize = parseInt(brushSizeRange.value);
            brushSizeDisplay.textContent = brushSize + 'px';
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø¬Ù… Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù…Ø¤Ø´Ø±
            brushCursor.style.width = brushSize * 2 + 'px';
            brushCursor.style.height = brushSize * 2 + 'px';
        });

        // === Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ===
        uploadImageBtn.addEventListener('click', () => imageInput.click());
        
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    processedImage = null;
                    
                    // ØªÙˆØ³ÙŠØ· Ø§Ù„ØµÙˆØ±Ø©
                    imageScale = Math.min(
                        canvasWidth / img.width * 0.9,
                        canvasHeight / img.height * 0.9,
                        1
                    );
                    imageX = (canvasWidth - img.width * imageScale) / 2;
                    imageY = (canvasHeight - img.height * imageScale) / 2;
                    
                    drawCanvas();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // === Ø§Ù„Ù‚Ø·Ø§Ø±Ø© ===
        eyedropperBtn.addEventListener('click', () => {
            isEyedropperActive = !isEyedropperActive;
            eyedropperBtn.classList.toggle('active');
            
            if (isEyedropperActive) {
                canvas.style.cursor = 'crosshair';
                brushCursor.style.display = 'none';
            } else {
                canvas.style.cursor = 'grab';
                if (currentTool) {
                    brushCursor.style.display = 'block';
                }
            }
        });

        // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ† Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©
        canvas.addEventListener('click', (e) => {
            if (!isEyedropperActive || !originalImage) return;
            
            const rect = canvas.getBoundingClientRect();
            const mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
            const mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            const imgX = Math.floor((mouseX - imageX) / imageScale);
            const imgY = Math.floor((mouseY - imageY) / imageScale);
            
            if (imgX >= 0 && imgY >= 0 && imgX < originalImage.width && imgY < originalImage.height) {
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = originalImage.width;
                tempCanvas.height = originalImage.height;
                tempCtx.drawImage(originalImage, 0, 0);
                
                const pixel = tempCtx.getImageData(imgX, imgY, 1, 1).data;
                targetColor = { r: pixel[0], g: pixel[1], b: pixel[2] };
                
                selectedColorBox.style.backgroundColor = `rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`;
                
                // Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚Ø·Ø§Ø±Ø©
                isEyedropperActive = false;
                eyedropperBtn.classList.remove('active');
                canvas.style.cursor = currentTool ? 'none' : 'grab';
                
                if (currentTool) {
                    brushCursor.style.display = 'block';
                }
            }
        });

        // === Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© ===
        removeBgBtn.addEventListener('click', () => {
            if (!originalImage) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = originalImage.width;
            tempCanvas.height = originalImage.height;
            tempCtx.drawImage(originalImage, 0, 0);
            
            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                const distance = Math.sqrt(
                    (r - targetColor.r) ** 2 +
                    (g - targetColor.g) ** 2 +
                    (b - targetColor.b) ** 2
                );
                
                if (distance < tolerance) {
                    data[i + 3] = 0; // Ø´ÙØ§Ù
                }
            }
            
            tempCtx.putImageData(imageData, 0, 0);
            
            const newImg = new Image();
            newImg.onload = () => {
                processedImage = newImg;
                drawCanvas();
            };
            newImg.src = tempCanvas.toDataURL();
        });

        // === Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙØ±Ø´Ø§Ø© ===
        eraserBtn.addEventListener('click', () => {
            currentTool = 'eraser';
            eraserBtn.classList.add('active');
            restoreBtn.classList.remove('active');
            canvas.style.cursor = 'none';
            brushCursor.style.display = 'block';
            
            // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
            brushCursor.style.borderColor = '#ef476f';
        });

        restoreBtn.addEventListener('click', () => {
            currentTool = 'restore';
            restoreBtn.classList.add('active');
            eraserBtn.classList.remove('active');
            canvas.style.cursor = 'none';
            brushCursor.style.display = 'block';
            
            // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
            brushCursor.style.borderColor = '#06d6a0';
        });

        // === Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ (Ø¬Ø¯ÙŠØ¯!) ===
        cancelToolBtn.addEventListener('click', () => {
            currentTool = null;
            eraserBtn.classList.remove('active');
            restoreBtn.classList.remove('active');
            canvas.style.cursor = 'grab';
            brushCursor.style.display = 'none';
        });

        // === Ø­Ø±ÙƒØ© Ù…Ø¤Ø´Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© ===
        canvas.addEventListener('mousemove', (e) => {
            if (!currentTool) return;
            
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX;
            const mouseY = e.clientY;
            
            // ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
            brushCursor.style.left = mouseX + 'px';
            brushCursor.style.top = mouseY + 'px';
            brushCursor.style.width = brushSize * 2 + 'px';
            brushCursor.style.height = brushSize * 2 + 'px';
        });

        // === Ø§Ù„Ø±Ø³Ù… (ÙŠØ´ØªØºÙ„ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· ÙˆØ§Ù„Ø³Ø­Ø¨) ===
        function handleDraw(e) {
            if (!isDrawing || !currentTool || !processedImage) return;
            
            const rect = canvas.getBoundingClientRect();
            const mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
            const mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            const imgX = Math.floor((mouseX - imageX) / imageScale);
            const imgY = Math.floor((mouseY - imageY) / imageScale);
            
            if (imgX < 0 || imgY < 0 || imgX >= processedImage.width || imgY >= processedImage.height) return;
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = processedImage.width;
            tempCanvas.height = processedImage.height;
            tempCtx.drawImage(processedImage, 0, 0);
            
            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;
            
            for (let y = -brushSize; y <= brushSize; y++) {
                for (let x = -brushSize; x <= brushSize; x++) {
                    const dist = Math.sqrt(x * x + y * y);
                    if (dist <= brushSize) {
                        const px = imgX + x;
                        const py = imgY + y;
                        
                        if (px >= 0 && px < tempCanvas.width && py >= 0 && py < tempCanvas.height) {
                            const idx = (py * tempCanvas.width + px) * 4;
                            
                            if (currentTool === 'eraser') {
                                data[idx + 3] = 0; // Ø´ÙØ§Ù
                            } else if (currentTool === 'restore' && originalImage) {
                                const origCanvas = document.createElement('canvas');
                                const origCtx = origCanvas.getContext('2d');
                                origCanvas.width = originalImage.width;
                                origCanvas.height = originalImage.height;
                                origCtx.drawImage(originalImage, 0, 0);
                                const origPixel = origCtx.getImageData(px, py, 1, 1).data;
                                
                                data[idx] = origPixel[0];
                                data[idx + 1] = origPixel[1];
                                data[idx + 2] = origPixel[2];
                                data[idx + 3] = 255;
                            }
                        }
                    }
                }
            }
            
            tempCtx.putImageData(imageData, 0, 0);
            
            const newImg = new Image();
            newImg.onload = () => {
                processedImage = newImg;
                drawCanvas();
            };
            newImg.src = tempCanvas.toDataURL();
        }

        // === Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø§ÙˆØ³ Ù„Ù„Ø±Ø³Ù… ÙˆØ§Ù„ØªØ­Ø±ÙŠÙƒ ===
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            if (currentTool) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø£Ø¯Ø§Ø© Ø§Ù„ÙØ±Ø´Ø§Ø© Ù…Ø­Ø¯Ø¯Ø©ØŒ Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø³Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
                isDrawing = true;
                handleDraw(e);
            } else {
                // Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠ Ø£Ø¯Ø§Ø©ØŒ Ù†Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø±ÙŠÙƒ
                if (e.shiftKey && backgroundImage) {
                    isDraggingBg = true;
                    dragStart.x = mouseX - bgX;
                    dragStart.y = mouseY - bgY;
                } else {
                    isDraggingImage = true;
                    dragStart.x = mouseX - imageX;
                    dragStart.y = mouseY - imageY;
                }
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDrawing) {
                handleDraw(e);
            } else {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                if (isDraggingImage) {
                    imageX = mouseX - dragStart.x;
                    imageY = mouseY - dragStart.y;
                    drawCanvas();
                } else if (isDraggingBg) {
                    bgX = mouseX - dragStart.x;
                    bgY = mouseY - dragStart.y;
                    drawCanvas();
                }
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
            isDraggingImage = false;
            isDraggingBg = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isDrawing = false;
            isDraggingImage = false;
            isDraggingBg = false;
            brushCursor.style.display = 'none';
        });

        canvas.addEventListener('mouseenter', () => {
            if (currentTool) {
                brushCursor.style.display = 'block';
            }
        });

        // === ØªÙƒØ¨ÙŠØ± ÙˆØªØµØºÙŠØ± Ø¨Ø§Ù„Ø¹Ø¬Ù„Ø© ===
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            
            if (e.shiftKey && backgroundImage) {
                const worldX = (mouseX - bgX) / bgScale;
                const worldY = (mouseY - bgY) / bgScale;
                bgScale *= delta;
                bgScale = Math.max(0.2, Math.min(3, bgScale));
                bgX = mouseX - worldX * bgScale;
                bgY = mouseY - worldY * bgScale;
            } else {
                const worldX = (mouseX - imageX) / imageScale;
                const worldY = (mouseY - imageY) / imageScale;
                imageScale *= delta;
                imageScale = Math.max(0.2, Math.min(3, imageScale));
                imageX = mouseX - worldX * imageScale;
                imageY = mouseY - worldY * imageScale;
            }
            
            drawCanvas();
        });

        // === Ø±ÙØ¹ Ø®Ù„ÙÙŠØ© Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² ===
        uploadBgArea.addEventListener('click', () => bgFileInput.click());
        
        bgFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    backgroundImage = img;
                    drawCanvas();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // === Ø§Ø®ØªÙŠØ§Ø± Ø®Ù„ÙÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© ===
        bgItems.forEach(item => {
            item.addEventListener('click', () => {
                const type = item.dataset.type;
                
                if (type === 'color') {
                    const color = item.dataset.color;
                    const bgImg = new Image();
                    bgImg.onload = () => {
                        backgroundImage = bgImg;
                        drawCanvas();
                    };
                    
                    const bgCanvas = document.createElement('canvas');
                    bgCanvas.width = 500;
                    bgCanvas.height = 500;
                    const bgCtx = bgCanvas.getContext('2d');
                    bgCtx.fillStyle = color;
                    bgCtx.fillRect(0, 0, 500, 500);
                    bgImg.src = bgCanvas.toDataURL();
                } else {
                    const url = item.dataset.url;
                    const bgImg = new Image();
                    bgImg.crossOrigin = 'anonymous';
                    bgImg.onload = () => {
                        backgroundImage = bgImg;
                        drawCanvas();
                    };
                    bgImg.src = url;
                }
                
                bgItems.forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
            });
        });

        // === Ø±Ø³Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ ===
        function drawCanvas() {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            // Ø±Ø³Ù… Ø§Ù„Ø®Ù„ÙÙŠØ©
            if (backgroundImage) {
                ctx.save();
                ctx.translate(bgX, bgY);
                ctx.scale(bgScale, bgScale);
                ctx.drawImage(backgroundImage, 0, 0);
                ctx.restore();
            } else {
                // Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ©
                ctx.fillStyle = '#2d2d3a';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);
                ctx.fillStyle = '#3d3d4e';
                for (let i = 0; i < canvasWidth; i += 40) {
                    for (let j = 0; j < canvasHeight; j += 40) {
                        ctx.fillRect(i, j, 20, 20);
                    }
                }
            }
            
            // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø©
            if (processedImage) {
                ctx.save();
                ctx.translate(imageX, imageY);
                ctx.scale(imageScale, imageScale);
                ctx.drawImage(processedImage, 0, 0);
                ctx.restore();
            } else if (originalImage) {
                ctx.save();
                ctx.translate(imageX, imageY);
                ctx.scale(imageScale, imageScale);
                ctx.drawImage(originalImage, 0, 0);
                ctx.restore();
            }
        }

        // === Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© ===
        saveBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'ØµÙˆØ±ØªÙŠ.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });

        // === Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®Ù„ÙÙŠØ§Øª ===
        addBgBtn.addEventListener('click', () => {
            bgFileInput.click();
        });

        // Ø±Ø³Ù… Ø£ÙˆÙ„ÙŠ
        drawCanvas();
    </script>
</body>
</html>
