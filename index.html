<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø­Ø±Ø± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Øª ØªØ¹Ù…Ù„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .editor-container {
            max-width: 1400px;
            width: 100%;
            background: white;
            border-radius: 30px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Ø±Ø£Ø³ Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .main-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            justify-content: center;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: #4361ee;
            color: white;
        }

        .btn-primary:hover {
            background: #3a56d4;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #06d6a0;
            color: white;
        }

        .btn-success:hover {
            background: #05bf8b;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #ef476f;
            color: white;
        }

        .btn-danger:hover {
            background: #d63e62;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ff9f1c;
            color: white;
        }

        .btn-warning:hover {
            background: #f08c0f;
            transform: translateY(-2px);
        }

        .btn-purple {
            background: #9d4edd;
            color: white;
        }

        .btn-purple:hover {
            background: #7b2cbf;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* Ø´Ø±ÙŠØ· Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ† */
        .color-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            padding: 15px 25px;
            background: white;
            border-bottom: 1px solid #dee2e6;
        }

        .color-display {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 5px 15px 5px 5px;
            border-radius: 40px;
            border: 1px solid #dee2e6;
        }

        #selectedColorBox {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .eyedropper-btn {
            background: #4361ee;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .eyedropper-btn.active {
            background: #06d6a0;
            transform: scale(1.1);
        }

        .tolerance-control {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 250px;
        }

        .tolerance-control label {
            font-weight: 600;
            color: #495057;
        }

        #toleranceRange {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #dee2e6;
            accent-color: #4361ee;
        }

        #toleranceValue {
            min-width: 35px;
            text-align: center;
            font-weight: 600;
            color: #4361ee;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ */
        .workspace {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: #e9ecef;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ */
        .canvas-wrapper {
            flex: 3;
            background: #2b2d42;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            aspect-ratio: 13/18;
        }

        #mainCanvas {
            width: 100%;
            height: 100%;
            display: block;
            background: repeating-conic-gradient(#4a4e69 0% 25%, #2b2d42 0% 50%) 50% / 30px 30px;
        }

        /* Ù…Ø¤Ø´Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© */
        .brush-cursor {
            position: fixed;
            width: 40px;
            height: 40px;
            border: 3px solid white;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
            display: none;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            mix-blend-mode: difference;
        }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        .sidebar {
            flex: 1;
            background: white;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* Ù‚ÙÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
        .lock-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
        }

        .lock-title {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lock-buttons {
            display: flex;
            gap: 10px;
        }

        .lock-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s;
            background: #e9ecef;
            color: #495057;
        }

        .lock-btn.active {
            background: #4361ee;
            color: white;
        }

        .lock-btn.bg-active {
            background: #9d4edd;
            color: white;
        }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙØ±Ø´Ø§Ø© */
        .tools-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
        }

        .tools-title {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .brush-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .brush-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s;
            background: #e9ecef;
            color: #495057;
        }

        .brush-btn.eraser.active {
            background: #ef476f;
            color: white;
        }

        .brush-btn.restore.active {
            background: #06d6a0;
            color: white;
        }

        .cancel-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #6c757d;
            color: white;
            margin-bottom: 15px;
        }

        .size-control {
            margin-top: 15px;
        }

        .size-label {
            display: flex;
            justify-content: space-between;
            color: #495057;
            margin-bottom: 5px;
        }

        #brushSizeRange {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #dee2e6;
            accent-color: #4361ee;
        }

        /* Ø®Ù„ÙÙŠØ§Øª */
        .backgrounds-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
        }

        .bg-title {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-bg {
            background: #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
            cursor: pointer;
            border: 2px dashed #adb5bd;
        }

        .upload-bg label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #495057;
            cursor: pointer;
        }

        #bgFileInput {
            display: none;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .color-item {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .color-item:hover {
            transform: scale(0.95);
            border-color: #4361ee;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .image-item {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            overflow: hidden;
        }

        .image-item:hover {
            border-color: #06d6a0;
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ØªØ¹Ù„ÙŠÙ…Ø§Øª */
        .instructions {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
        }

        .instructions p {
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #495057;
            font-size: 13px;
        }

        /* ØªØ°ÙŠÙŠÙ„ */
        .footer {
            background: #2b2d42;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <div class="header">
            <h1>ğŸ¨ Ø§Ù„Ù…Ø­Ø±Ø± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</h1>
            <p>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Øª ØªØ¹Ù…Ù„ - Ù…Ù…Ø­Ø§Ø© - Ø§Ø³ØªØ¹Ø§Ø¯Ø© - Ù‚Øµ - Ø®Ù„ÙÙŠØ§Øª - ØªÙƒØ¨ÙŠØ± - ØªØ­Ø±ÙŠÙƒ</p>
        </div>

        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div class="main-toolbar">
            <button class="btn btn-primary" id="uploadBtn">
                <span>ğŸ“¸</span> Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©
            </button>
            <button class="btn btn-success" id="removeBgBtn">
                <span>âœ‚ï¸</span> Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©
            </button>
            <button class="btn btn-warning" id="cropBtn">
                <span>ğŸ”²</span> Ù‚Øµ Ø§Ù„ØµÙˆØ±Ø©
            </button>
            <button class="btn btn-danger" id="undoBtn">
                <span>â†©ï¸</span> Ø±Ø¬ÙˆØ¹
            </button>
            <button class="btn btn-purple" id="addBgBtn">
                <span>ğŸ–¼ï¸</span> Ø¥Ø¶Ø§ÙØ© Ø®Ù„ÙÙŠØ©
            </button>
            <button class="btn btn-secondary" id="saveBtn">
                <span>ğŸ’¾</span> Ø­ÙØ¸
            </button>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
        </div>

        <!-- Ø´Ø±ÙŠØ· Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ† -->
        <div class="color-bar">
            <div class="color-display">
                <div id="selectedColorBox" style="background: #00ff00;"></div>
                <span>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</span>
            </div>

            <button class="eyedropper-btn" id="eyedropperBtn" title="Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ† Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©">
                ğŸ–Œï¸
            </button>

            <div class="tolerance-control">
                <label>Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©:</label>
                <input type="range" id="toleranceRange" min="5" max="60" value="30">
                <span id="toleranceValue">30</span>
            </div>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ -->
        <div class="workspace">
            <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ -->
            <div class="canvas-wrapper">
                <canvas id="mainCanvas"></canvas>
            </div>

            <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
            <div class="sidebar">
                <!-- Ù‚ÙÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± -->
                <div class="lock-panel">
                    <div class="lock-title">
                        <span>ğŸ”’</span> Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¹Ù†Ø§ØµØ±
                    </div>
                    <div class="lock-buttons">
                        <button class="lock-btn active" id="lockImageBtn">
                            <span>ğŸ–¼ï¸</span> Ø§Ù„ØµÙˆØ±Ø©
                        </button>
                        <button class="lock-btn" id="lockBgBtn">
                            <span>ğŸŒˆ</span> Ø§Ù„Ø®Ù„ÙÙŠØ©
                        </button>
                    </div>
                </div>

                <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙØ±Ø´Ø§Ø© -->
                <div class="tools-panel">
                    <div class="tools-title">
                        <span>ğŸ–Œï¸</span> Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ±
                    </div>

                    <button class="cancel-btn" id="cancelToolBtn">
                        <span>âŒ</span> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                    </button>

                    <div class="brush-buttons">
                        <button class="brush-btn eraser" id="eraserBtn">
                            <span>ğŸ§½</span> Ù…Ù…Ø­Ø§Ø©
                        </button>
                        <button class="brush-btn restore" id="restoreBtn">
                            <span>ğŸ”„</span> Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                        </button>
                    </div>

                    <div class="size-control">
                        <div class="size-label">
                            <span>Ø­Ø¬Ù… Ø§Ù„ÙØ±Ø´Ø§Ø©</span>
                            <span id="brushSizeDisplay">20px</span>
                        </div>
                        <input type="range" id="brushSizeRange" min="5" max="50" value="20">
                    </div>
                </div>

                <!-- Ø§Ù„Ø®Ù„ÙÙŠØ§Øª -->
                <div class="backgrounds-panel">
                    <div class="bg-title">
                        <span>ğŸŒˆ</span> Ø§Ù„Ø®Ù„ÙÙŠØ§Øª
                    </div>

                    <div class="upload-bg" id="uploadBgArea">
                        <label for="bgFileInput">
                            <span>ğŸ“</span> Ø§Ø®ØªØ± Ø®Ù„ÙÙŠØ© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ
                        </label>
                        <input type="file" id="bgFileInput" accept="image/*">
                    </div>

                    <div style="margin-bottom: 10px; color: #495057;">Ø£Ù„ÙˆØ§Ù†:</div>
                    <div class="color-grid">
                        <div class="color-item" style="background: #ff0000;" data-color="#ff0000"></div>
                        <div class="color-item" style="background: #00ff00;" data-color="#00ff00"></div>
                        <div class="color-item" style="background: #0000ff;" data-color="#0000ff"></div>
                        <div class="color-item" style="background: #ffff00;" data-color="#ffff00"></div>
                        <div class="color-item" style="background: #ff00ff;" data-color="#ff00ff"></div>
                        <div class="color-item" style="background: #00ffff;" data-color="#00ffff"></div>
                        <div class="color-item" style="background: #ffffff; border: 1px solid #ced4da;" data-color="#ffffff"></div>
                        <div class="color-item" style="background: #000000;" data-color="#000000"></div>
                        <div class="color-item" style="background: #808080;" data-color="#808080"></div>
                    </div>

                    <div style="margin: 15px 0 10px; color: #495057;">ØµÙˆØ±:</div>
                    <div class="image-grid">
                        <div class="image-item" data-type="image" data-url="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=200">
                            <img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=200" alt="Ø·Ø¨ÙŠØ¹Ø©" crossorigin="anonymous" loading="lazy">
                        </div>
                        <div class="image-item" data-type="image" data-url="https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=200">
                            <img src="https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=200" alt="ØºØ§Ø¨Ø©" crossorigin="anonymous" loading="lazy">
                        </div>
                        <div class="image-item" data-type="image" data-url="https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=200">
                            <img src="https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=200" alt="ØºØ±ÙˆØ¨" crossorigin="anonymous" loading="lazy">
                        </div>
                        <div class="image-item" data-type="image" data-url="https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=200">
                            <img src="https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=200" alt="Ø¨Ø­ÙŠØ±Ø©" crossorigin="anonymous" loading="lazy">
                        </div>
                    </div>
                </div>

                <!-- ØªØ¹Ù„ÙŠÙ…Ø§Øª -->
                <div class="instructions">
                    <p><span style="color: #4361ee;">â—</span> Ø§Ù„Ù‚ÙÙ„: Ø§Ø®ØªØ± Ø§Ù„ØµÙˆØ±Ø© Ø£Ùˆ Ø§Ù„Ø®Ù„ÙÙŠØ©</p>
                    <p><span style="color: #ef476f;">â—</span> Ù…Ù…Ø­Ø§Ø©: Ø§Ø¶ØºØ· + Ø§Ø³Ø­Ø¨ Ù„Ù…Ø³Ø­</p>
                    <p><span style="color: #06d6a0;">â—</span> Ø§Ø³ØªØ¹Ø§Ø¯Ø©: Ø§Ø¶ØºØ· + Ø§Ø³Ø­Ø¨ Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</p>
                    <p><span style="color: #ff9f1c;">â—</span> Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø§ÙˆØ³: ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù†Ø´Ø·</p>
                    <p><span style="color: #9d4edd;">â—</span> Ø³Ø­Ø¨: ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù†Ø´Ø·</p>
                </div>
            </div>
        </div>

        <!-- ØªØ°ÙŠÙŠÙ„ -->
        <div class="footer">
            Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2024 - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Øª ØªØ¹Ù…Ù„ Ø¨ÙƒÙØ§Ø¡Ø© Ø¹Ø§Ù„ÙŠØ©
        </div>
    </div>

    <!-- Ù…Ø¤Ø´Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© -->
    <div class="brush-cursor" id="brushCursor"></div>

    <script>
        // ==========================================
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³
        // ==========================================
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        // Ø¶Ø¨Ø· Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ (13 Ã— 18 Ø³Ù…)
        canvas.width = 800;
        canvas.height = 1108;

        // ==========================================
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        // ==========================================
        let originalImage = null;        // Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        let processedImage = null;        // Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©
        let backgroundImage = null;        // Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø¶Ø§ÙØ©
        
        // Ø³Ø¬Ù„ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ (Ø¢Ø®Ø± 10 ØªØ¹Ø¯ÙŠÙ„Ø§Øª)
        let history = [];
        
        // Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù
        let targetColor = { r: 0, g: 255, b: 0 };
        let tolerance = 30;
        
        // Ø§Ù„Ù‚Ø·Ø§Ø±Ø©
        let isEyedropperActive = false;
        
        // Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙØ±Ø´Ø§Ø©
        let currentTool = null; // 'eraser', 'restore', Ø£Ùˆ null
        let isDrawing = false;
        let brushSize = 20;
        
        // Ù‚ÙÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
        let activeElement = 'image'; // 'image' Ø£Ùˆ 'background'
        
        // Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
        let imgX = 0, imgY = 0, imgScale = 1;
        let bgX = 0, bgY = 0, bgScale = 1;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };

        // Ù…Ø¤Ø´Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
        const brushCursor = document.getElementById('brushCursor');

        // ==========================================
        // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…
        // ==========================================
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const removeBgBtn = document.getElementById('removeBgBtn');
        const cropBtn = document.getElementById('cropBtn');
        const undoBtn = document.getElementById('undoBtn');
        const addBgBtn = document.getElementById('addBgBtn');
        const saveBtn = document.getElementById('saveBtn');
        const eyedropperBtn = document.getElementById('eyedropperBtn');
        const selectedColorBox = document.getElementById('selectedColorBox');
        const toleranceRange = document.getElementById('toleranceRange');
        const toleranceValue = document.getElementById('toleranceValue');
        const eraserBtn = document.getElementById('eraserBtn');
        const restoreBtn = document.getElementById('restoreBtn');
        const cancelToolBtn = document.getElementById('cancelToolBtn');
        const brushSizeRange = document.getElementById('brushSizeRange');
        const brushSizeDisplay = document.getElementById('brushSizeDisplay');
        const lockImageBtn = document.getElementById('lockImageBtn');
        const lockBgBtn = document.getElementById('lockBgBtn');
        const uploadBgArea = document.getElementById('uploadBgArea');
        const bgFileInput = document.getElementById('bgFileInput');
        const colorItems = document.querySelectorAll('.color-item');
        const imageItems = document.querySelectorAll('.image-item');

        // ==========================================
        // ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
        // ==========================================
        
        // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„ØªØ±Ø§Ø¬Ø¹
        function saveToHistory() {
            if (!processedImage) return;
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = processedImage.width;
            tempCanvas.height = processedImage.height;
            tempCtx.drawImage(processedImage, 0, 0);
            history.push(tempCanvas.toDataURL());
            
            if (history.length > 10) history.shift();
        }

        // Ø±Ø³Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³
        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Ø±Ø³Ù… Ø§Ù„Ø®Ù„ÙÙŠØ©
            if (backgroundImage) {
                ctx.save();
                ctx.translate(bgX, bgY);
                ctx.scale(bgScale, bgScale);
                ctx.drawImage(backgroundImage, 0, 0);
                ctx.restore();
            }
            
            // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø©
            if (processedImage) {
                ctx.save();
                ctx.translate(imgX, imgY);
                ctx.scale(imgScale, imgScale);
                ctx.drawImage(processedImage, 0, 0);
                ctx.restore();
            } else if (originalImage) {
                ctx.save();
                ctx.translate(imgX, imgY);
                ctx.scale(imgScale, imgScale);
                ctx.drawImage(originalImage, 0, 0);
                ctx.restore();
            }
        }

        // ==========================================
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…
        // ==========================================
        toleranceRange.addEventListener('input', () => {
            tolerance = parseInt(toleranceRange.value);
            toleranceValue.textContent = tolerance;
        });

        brushSizeRange.addEventListener('input', () => {
            brushSize = parseInt(brushSizeRange.value);
            brushSizeDisplay.textContent = brushSize + 'px';
            brushCursor.style.width = (brushSize * 2) + 'px';
            brushCursor.style.height = (brushSize * 2) + 'px';
        });

        // ==========================================
        // Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚ÙÙ„
        // ==========================================
        lockImageBtn.addEventListener('click', () => {
            activeElement = 'image';
            lockImageBtn.classList.add('active');
            lockBgBtn.classList.remove('active', 'bg-active');
        });

        lockBgBtn.addEventListener('click', () => {
            activeElement = 'background';
            lockBgBtn.classList.add('active', 'bg-active');
            lockImageBtn.classList.remove('active');
        });

        // ==========================================
        // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
        // ==========================================
        uploadBtn.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    processedImage = null;
                    history = [];
                    
                    // ØªÙˆØ³ÙŠØ· Ø§Ù„ØµÙˆØ±Ø©
                    const scale = Math.min(
                        canvas.width / img.width * 0.8,
                        canvas.height / img.height * 0.8
                    );
                    imgScale = scale;
                    imgX = (canvas.width - img.width * imgScale) / 2;
                    imgY = (canvas.height - img.height * imgScale) / 2;
                    
                    drawCanvas();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // ==========================================
        // Ø§Ù„Ù‚Ø·Ø§Ø±Ø©
        // ==========================================
        eyedropperBtn.addEventListener('click', () => {
            isEyedropperActive = !isEyedropperActive;
            eyedropperBtn.classList.toggle('active');
            canvas.style.cursor = isEyedropperActive ? 'crosshair' : 'default';
        });

        canvas.addEventListener('click', (e) => {
            if (!isEyedropperActive || !originalImage) return;
            
            const rect = canvas.getBoundingClientRect();
            const mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
            const mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            const ix = Math.floor((mouseX - imgX) / imgScale);
            const iy = Math.floor((mouseY - imgY) / imgScale);
            
            if (ix >= 0 && iy >= 0 && ix < originalImage.width && iy < originalImage.height) {
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = originalImage.width;
                tempCanvas.height = originalImage.height;
                tempCtx.drawImage(originalImage, 0, 0);
                
                const pixel = tempCtx.getImageData(ix, iy, 1, 1).data;
                targetColor = { r: pixel[0], g: pixel[1], b: pixel[2] };
                selectedColorBox.style.backgroundColor = `rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`;
                
                isEyedropperActive = false;
                eyedropperBtn.classList.remove('active');
                canvas.style.cursor = 'default';
            }
        });

        // ==========================================
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©
        // ==========================================
        removeBgBtn.addEventListener('click', () => {
            if (!originalImage) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = originalImage.width;
            tempCanvas.height = originalImage.height;
            tempCtx.drawImage(originalImage, 0, 0);
            
            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                const dist = Math.sqrt(
                    (r - targetColor.r) ** 2 +
                    (g - targetColor.g) ** 2 +
                    (b - targetColor.b) ** 2
                );
                
                if (dist < tolerance) {
                    data[i + 3] = 0;
                }
            }
            
            tempCtx.putImageData(imageData, 0, 0);
            
            const newImg = new Image();
            newImg.onload = () => {
                processedImage = newImg;
                saveToHistory();
                drawCanvas();
            };
            newImg.src = tempCanvas.toDataURL();
        });

        // ==========================================
        // Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙØ±Ø´Ø§Ø©
        // ==========================================
        eraserBtn.addEventListener('click', () => {
            currentTool = 'eraser';
            eraserBtn.classList.add('active');
            restoreBtn.classList.remove('active');
            canvas.style.cursor = 'none';
            brushCursor.style.display = 'block';
            brushCursor.style.borderColor = '#ef476f';
        });

        restoreBtn.addEventListener('click', () => {
            currentTool = 'restore';
            restoreBtn.classList.add('active');
            eraserBtn.classList.remove('active');
            canvas.style.cursor = 'none';
            brushCursor.style.display = 'block';
            brushCursor.style.borderColor = '#06d6a0';
        });

        cancelToolBtn.addEventListener('click', () => {
            currentTool = null;
            eraserBtn.classList.remove('active');
            restoreBtn.classList.remove('active');
            canvas.style.cursor = 'default';
            brushCursor.style.display = 'none';
        });

        // ==========================================
        // Ø§Ù„Ø±Ø³Ù… (Ù…Ù…Ø­Ø§Ø© ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø©)
        // ==========================================
        function drawBrush(x, y) {
            if (!currentTool || !processedImage || !originalImage) return;
            
            const ix = Math.floor((x - imgX) / imgScale);
            const iy = Math.floor((y - imgY) / imgScale);
            
            if (ix < 0 || iy < 0 || ix >= processedImage.width || iy >= processedImage.height) return;
            
            // Ø¥Ù†Ø´Ø§Ø¡ canvas Ù…Ø¤Ù‚Øª
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = processedImage.width;
            tempCanvas.height = processedImage.height;
            tempCtx.drawImage(processedImage, 0, 0);
            
            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;
            
            // Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
            const origCanvas = document.createElement('canvas');
            const origCtx = origCanvas.getContext('2d');
            origCanvas.width = originalImage.width;
            origCanvas.height = originalImage.height;
            origCtx.drawImage(originalImage, 0, 0);
            const origData = origCtx.getImageData(0, 0, origCanvas.width, origCanvas.height).data;
            
            // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠÙƒØ³Ù„Ø§Øª
            for (let dy = -brushSize; dy <= brushSize; dy++) {
                for (let dx = -brushSize; dx <= brushSize; dx++) {
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist <= brushSize) {
                        const px = ix + dx;
                        const py = iy + dy;
                        
                        if (px >= 0 && px < tempCanvas.width && py >= 0 && py < tempCanvas.height) {
                            const idx = (py * tempCanvas.width + px) * 4;
                            
                            if (currentTool === 'eraser') {
                                data[idx + 3] = 0;
                            } else {
                                const oidx = (py * origCanvas.width + px) * 4;
                                data[idx] = origData[oidx];
                                data[idx + 1] = origData[oidx + 1];
                                data[idx + 2] = origData[oidx + 2];
                                data[idx + 3] = 255;
                            }
                        }
                    }
                }
            }
            
            tempCtx.putImageData(imageData, 0, 0);
            
            const newImg = new Image();
            newImg.onload = () => {
                processedImage = newImg;
                drawCanvas();
            };
            newImg.src = tempCanvas.toDataURL();
        }

        // ==========================================
        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø§ÙˆØ³
        // ==========================================
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            if (currentTool && processedImage) {
                isDrawing = true;
                saveToHistory();
                drawBrush(mouseX, mouseY);
            } else {
                isDragging = true;
                if (activeElement === 'image') {
                    dragStart.x = mouseX - imgX;
                    dragStart.y = mouseY - imgY;
                } else if (activeElement === 'background' && backgroundImage) {
                    dragStart.x = mouseX - bgX;
                    dragStart.y = mouseY - bgY;
                }
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
            if (currentTool) {
                brushCursor.style.left = e.clientX + 'px';
                brushCursor.style.top = e.clientY + 'px';
            }
            
            if (isDrawing && currentTool) {
                drawBrush(mouseX, mouseY);
            } else if (isDragging) {
                if (activeElement === 'image') {
                    imgX = mouseX - dragStart.x;
                    imgY = mouseY - dragStart.y;
                } else if (activeElement === 'background' && backgroundImage) {
                    bgX = mouseX - dragStart.x;
                    bgY = mouseY - dragStart.y;
                }
                drawCanvas();
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
            isDragging = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isDrawing = false;
            isDragging = false;
            brushCursor.style.display = 'none';
        });

        canvas.addEventListener('mouseenter', () => {
            if (currentTool) {
                brushCursor.style.display = 'block';
            }
        });

        // ==========================================
        // Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„ØªØµØºÙŠØ± (Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø§ÙˆØ³)
        // ==========================================
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            
            if (activeElement === 'image') {
                const worldX = (mouseX - imgX) / imgScale;
                const worldY = (mouseY - imgY) / imgScale;
                imgScale *= delta;
                imgScale = Math.max(0.2, Math.min(5, imgScale));
                imgX = mouseX - worldX * imgScale;
                imgY = mouseY - worldY * imgScale;
            } else if (activeElement === 'background' && backgroundImage) {
                const worldX = (mouseX - bgX) / bgScale;
                const worldY = (mouseY - bgY) / bgScale;
                bgScale *= delta;
                bgScale = Math.max(0.2, Math.min(5, bgScale));
                bgX = mouseX - worldX * bgScale;
                bgY = mouseY - worldY * bgScale;
            }
            
            drawCanvas();
        });

        // ==========================================
        // Ù‚Øµ Ø§Ù„ØµÙˆØ±Ø©
        // ==========================================
        let isCropMode = false;
        let cropStart = { x: 0, y: 0 };
        let cropEnd = { x: 0, y: 0 };
        let cropOverlay = null;
        let cropBox = null;

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Øµ
        function createCropElements() {
            const container = document.querySelector('.canvas-wrapper');
            
            cropOverlay = document.createElement('div');
            cropOverlay.style.position = 'absolute';
            cropOverlay.style.top = '0';
            cropOverlay.style.left = '0';
            cropOverlay.style.width = '100%';
            cropOverlay.style.height = '100%';
            cropOverlay.style.background = 'rgba(0,0,0,0.5)';
            cropOverlay.style.display = 'none';
            cropOverlay.style.zIndex = '10';
            
            cropBox = document.createElement('div');
            cropBox.style.position = 'absolute';
            cropBox.style.border = '3px solid #4cc9f0';
            cropBox.style.background = 'rgba(76, 201, 240, 0.1)';
            cropBox.style.cursor = 'move';
            
            const controls = document.createElement('div');
            controls.style.position = 'absolute';
            controls.style.bottom = '20px';
            controls.style.left = '50%';
            controls.style.transform = 'translateX(-50%)';
            controls.style.display = 'flex';
            controls.style.gap = '10px';
            controls.style.zIndex = '20';
            
            const applyBtn = document.createElement('button');
            applyBtn.textContent = 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Øµ';
            applyBtn.style.padding = '10px 25px';
            applyBtn.style.border = 'none';
            applyBtn.style.borderRadius = '30px';
            applyBtn.style.background = '#4cc9f0';
            applyBtn.style.color = 'black';
            applyBtn.style.fontWeight = '600';
            applyBtn.style.cursor = 'pointer';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Ø¥Ù„ØºØ§Ø¡';
            cancelBtn.style.padding = '10px 25px';
            cancelBtn.style.border = 'none';
            cancelBtn.style.borderRadius = '30px';
            cancelBtn.style.background = '#ef476f';
            cancelBtn.style.color = 'white';
            cancelBtn.style.fontWeight = '600';
            cancelBtn.style.cursor = 'pointer';
            
            controls.appendChild(applyBtn);
            controls.appendChild(cancelBtn);
            
            cropOverlay.appendChild(cropBox);
            cropOverlay.appendChild(controls);
            container.appendChild(cropOverlay);
            
            // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            applyBtn.addEventListener('click', applyCrop);
            cancelBtn.addEventListener('click', cancelCrop);
        }

        cropBtn.addEventListener('click', () => {
            if (!processedImage) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            if (!cropOverlay) createCropElements();
            
            isCropMode = true;
            cropOverlay.style.display = 'block';
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ
            cropStart.x = canvas.width * 0.2;
            cropStart.y = canvas.height * 0.2;
            cropEnd.x = canvas.width * 0.8;
            cropEnd.y = canvas.height * 0.8;
            
            updateCropBox();
        });

        function updateCropBox() {
            const left = Math.min(cropStart.x, cropEnd.x);
            const top = Math.min(cropStart.y, cropEnd.y);
            const right = Math.max(cropStart.x, cropEnd.x);
            const bottom = Math.max(cropStart.y, cropEnd.y);
            
            cropBox.style.left = left + 'px';
            cropBox.style.top = top + 'px';
            cropBox.style.width = (right - left) + 'px';
            cropBox.style.height = (bottom - top) + 'px';
        }

        function applyCrop() {
            if (!processedImage) return;
            
            const left = Math.min(cropStart.x, cropEnd.x);
            const top = Math.min(cropStart.y, cropEnd.y);
            const right = Math.max(cropStart.x, cropEnd.x);
            const bottom = Math.max(cropStart.y, cropEnd.y);
            
            const cropX = Math.max(0, left);
            const cropY = Math.max(0, top);
            const cropW = Math.min(right - left, canvas.width - cropX);
            const cropH = Math.min(bottom - top, canvas.height - cropY);
            
            if (cropW < 10 || cropH < 10) {
                alert('Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù‚Øµ ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹');
                return;
            }
            
            // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„ØµÙˆØ±Ø©
            const imgCropX = Math.floor((cropX - imgX) / imgScale);
            const imgCropY = Math.floor((cropY - imgY) / imgScale);
            const imgCropW = Math.floor(cropW / imgScale);
            const imgCropH = Math.floor(cropH / imgScale);
            
            if (imgCropX < 0 || imgCropY < 0 || 
                imgCropX + imgCropW > processedImage.width || 
                imgCropY + imgCropH > processedImage.height) {
                alert('Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù‚Øµ Ø®Ø§Ø±Ø¬ Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙˆØ±Ø©');
                return;
            }
            
            // Ù‚Øµ Ø§Ù„ØµÙˆØ±Ø©
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = imgCropW;
            tempCanvas.height = imgCropH;
            tempCtx.drawImage(processedImage, imgCropX, imgCropY, imgCropW, imgCropH, 0, 0, imgCropW, imgCropH);
            
            const newImg = new Image();
            newImg.onload = () => {
                processedImage = newImg;
                saveToHistory();
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ³ÙŠØ· Ø§Ù„ØµÙˆØ±Ø©
                imgScale = Math.min(
                    canvas.width / newImg.width * 0.8,
                    canvas.height / newImg.height * 0.8
                );
                imgX = (canvas.width - newImg.width * imgScale) / 2;
                imgY = (canvas.height - newImg.height * imgScale) / 2;
                
                isCropMode = false;
                cropOverlay.style.display = 'none';
                drawCanvas();
            };
            newImg.src = tempCanvas.toDataURL();
        }

        function cancelCrop() {
            isCropMode = false;
            cropOverlay.style.display = 'none';
        }

        // ==========================================
        // ØªØ±Ø§Ø¬Ø¹ (Undo)
        // ==========================================
        undoBtn.addEventListener('click', () => {
            if (history.length === 0) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ±Ø§Ø¬Ø¹');
                return;
            }
            
            const lastState = history.pop();
            const img = new Image();
            img.onload = () => {
                processedImage = img;
                drawCanvas();
            };
            img.src = lastState;
        });

        // ==========================================
        // Ø§Ù„Ø®Ù„ÙÙŠØ§Øª
        // ==========================================
        
        // Ø®Ù„ÙÙŠØ§Øª Ù…Ù„ÙˆÙ†Ø©
        colorItems.forEach(item => {
            item.addEventListener('click', () => {
                const color = item.dataset.color;
                
                const bgImg = new Image();
                bgImg.onload = () => {
                    backgroundImage = bgImg;
                    bgX = (canvas.width - bgImg.width * bgScale) / 2;
                    bgY = (canvas.height - bgImg.height * bgScale) / 2;
                    drawCanvas();
                };
                
                const bgCanvas = document.createElement('canvas');
                bgCanvas.width = 500;
                bgCanvas.height = 500;
                const bgCtx = bgCanvas.getContext('2d');
                bgCtx.fillStyle = color;
                bgCtx.fillRect(0, 0, 500, 500);
                bgImg.src = bgCanvas.toDataURL();
            });
        });

        // Ø®Ù„ÙÙŠØ§Øª ØµÙˆØ±
        imageItems.forEach(item => {
            item.addEventListener('click', () => {
                const url = item.dataset.url;
                
                const bgImg = new Image();
                bgImg.crossOrigin = 'anonymous';
                bgImg.onload = () => {
                    backgroundImage = bgImg;
                    bgX = (canvas.width - bgImg.width * bgScale) / 2;
                    bgY = (canvas.height - bgImg.height * bgScale) / 2;
                    drawCanvas();
                };
                bgImg.src = url;
            });
        });

        // Ø±ÙØ¹ Ø®Ù„ÙÙŠØ© Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²
        uploadBgArea.addEventListener('click', () => bgFileInput.click());
        
        bgFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    backgroundImage = img;
                    bgX = (canvas.width - img.width * bgScale) / 2;
                    bgY = (canvas.height - img.height * bgScale) / 2;
                    drawCanvas();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø®Ù„ÙÙŠØ©
        addBgBtn.addEventListener('click', () => {
            bgFileInput.click();
        });

        // ==========================================
        // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©
        // ==========================================
        saveBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'ØµÙˆØ±ØªÙŠ.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });

        // ==========================================
        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ÙŠ
        // ==========================================
        drawCanvas();
    </script>
</body>
</html>
